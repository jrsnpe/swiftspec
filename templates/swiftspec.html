<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SwiftSpec - You Awe-Inspiring APIs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/monokai.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.6;
        color: #3b4151;
        background-color: #f8f9fa;
      }
      #header {
        background-color: #343a40;
        color: white;
        padding: 20px;
      }
      #content {
        display: flex;
        min-height: calc(100vh - 60px);
      }
      #sidebar {
        width: 300px;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
      }
      #main {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
      }
      .api-item {
        background-color: #fff;
        border: 1px solid #dee2e6;
        margin-bottom: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      }
      .api-item-header {
        display: flex;
        align-items: center;
        padding: 15px;
        cursor: pointer;
        border-bottom: 1px solid #dee2e6;
        transition: background-color 0.3s ease;
      }
      .api-item-header:hover {
        background-color: #f1f3f5;
      }
      .method {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 14px;
        min-width: 80px;
        text-align: center;
      }
      .get {
        background-color: #61affe;
        color: #fff;
      }
      .post {
        background-color: #49cc90;
        color: #fff;
      }
      .put {
        background-color: #fca130;
        color: #fff;
      }
      .delete {
        background-color: #f93e3e;
        color: #fff;
      }
      .path {
        font-family: monospace;
        margin-left: 10px;
      }
      .api-item-content {
        padding: 20px;
      }
      .sidebar-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #dee2e6;
        transition: background-color 0.3s ease;
      }
      .sidebar-item:hover {
        background-color: #e9ecef;
      }
      .version-tag {
        font-size: 12px;
        background-color: #e7f3fe;
        color: #1e88e5;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 10px;
      }
      .param-required {
        color: #dc3545;
        font-weight: bold;
      }
      .param-optional {
        color: #28a745;
      }
      .auth-required {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        margin-bottom: 15px;
      }
      .deprecated {
        text-decoration: line-through;
        color: #6c757d;
      }
      .schema {
        font-family: monospace;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
      }
      .fade-transition {
        transition: opacity 0.3s ease;
      }
      .format-selector {
        margin-top: 10px;
      }
      .response-body {
        background-color: #1e1e1e;
        border-radius: 4px;
        padding: 15px;
        position: relative;
      }
      .response-body pre {
        margin: 0;
      }
      .response-body code {
        color: #d4d4d4;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
      }
      .copy-button {
        position: absolute;
        top: 5px;
        right: 5px;
        padding: 5px 10px;
        background-color: #4a4a4a;
        color: #ffffff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      .copy-button:hover {
        background-color: #5a5a5a;
      }
      .try-it-out-accordion .accordion-button {
        background-color: #007bff;
        color: white;
      }
      .try-it-out-accordion .accordion-button:not(.collapsed) {
        background-color: #0056b3;
        color: white;
      }
      .try-it-out-accordion .accordion-button:focus {
        box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
      }
      .try-it-out-accordion .accordion-button::after {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
      }
      .nav-tabs .nav-link {
        color: #495057;
      }
      .nav-tabs .nav-link.active {
        font-weight: bold;
      }
      .tab-content {
        padding-top: 20px;
      }
      .hero {
        background: rgb(1, 38, 78);
        background: linear-gradient(180deg, rgba(1, 38, 78, 1) 0%, rgba(0, 86, 179, 1) 100%);
        color: white;
        margin-bottom: 2rem;
      }
      .hero img {
        max-width: 200px;
        margin-bottom: 1rem;
      }
      .hero h1 {
        font-size: 3.5rem;
        font-weight: bold;
      }
      .hero p {
        font-size: 1.5rem;
        opacity: 0.9;
        padding-bottom: 2rem;
      }
      #header {
        background-color: #0056b3;
      }
      .btn-outline-light:hover {
        background-color: #00a0e9;
        border-color: #00a0e9;
      }
    </style>
  </head>
  <body>
    <div class="hero text-center">
      <img src="assets/swiftspec-logo-w.png" alt="SwiftSpec Logo" class="img-fluid" />
    </div>

    <div id="header" class="d-flex justify-content-between align-items-center">
      <h2 class="text-white m-0">Documentação da API</h2>
      <nav>
        <a href="about.html" class="btn btn-outline-light me-2">Sobre o SwiftSpec</a>
        <a href="execution-report.html" class="btn btn-outline-light">Relatório</a>
      </nav>
    </div>
    <div id="content" class="d-flex">
      <div id="sidebar" class="bg-light p-3">
        <h4>Endpoints</h4>
        <div id="sidebar-content"></div>
      </div>
      <div id="main" class="flex-grow-1 p-4">
        <div id="api-content"></div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function cleanApiDocs(docs) {
        return docs.map((doc) => ({
          ...doc,
          method: doc.method.replace(/[{}\s]/g, ""),
        }));
      }

      const apiDocs = cleanApiDocs(JSON.parse(decodeURIComponent("{{API_DOCS_JSON}}")));
      console.log("apiDocs:", apiDocs);

      function renderSidebar() {
        const sidebarContent = document.getElementById("sidebar-content");
        apiDocs.forEach((api, index) => {
          const item = document.createElement("div");
          item.className = "sidebar-item";
          item.textContent = `${api.method} ${api.path}`;
          item.onclick = () => showApiItem(index);
          sidebarContent.appendChild(item);
        });
      }

      function showApiItem(index) {
        const apiContent = document.getElementById("api-content");

        apiContent.classList.remove("fade-transition");
        apiContent.style.opacity = 0;

        setTimeout(() => {
          apiContent.innerHTML = generateApiHtml(apiDocs[index]);
          apiContent.classList.add("fade-transition");
          apiContent.style.opacity = 1;

          initAccordions();
          hljs.highlightAll();
        }, 300);
      }

      function generateApiHtml(info) {
        const pathParams = info.path.match(/:[a-zA-Z]+/g) || [];
        const queryParams = info.params.filter((param) => {
          const paramName = param.split(" ")[0];
          return !pathParams.includes(`:${paramName}`);
        });

        return `
          <div class="api-item">
            <div class="api-item-header">
              <span class="method ${info.method.toLowerCase()}">${info.method}</span>
              <span class="path">${info.path}</span>
              <span class="version-tag">v${info.version}</span>
            </div>
            <div class="api-item-content">
              <h2>${info.summary}</h2>
              <p>${info.description}</p>
              
              ${
                info.authRequired
                  ? `
                <div class="auth-required">
                  <strong>Autenticação requerida:</strong> Este endpoint requer autenticação.
                </div>
              `
                  : ""
              }

              ${
                info.deprecated
                  ? `
                <div class="deprecated">
                  <strong>Deprecated:</strong> Este endpoint está obsoleto e será removido em versões futuras.
                </div>
              `
                  : ""
              }

              <div class="accordion" id="apiAccordion">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingParameters">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseParameters" aria-expanded="true" aria-controls="collapseParameters">
                      Parâmetros
                    </button>
                  </h2>
                  <div id="collapseParameters" class="accordion-collapse collapse show" aria-labelledby="headingParameters" data-bs-parent="#apiAccordion">
                    <div class="accordion-body">
                      ${
                        info.params.length > 0
                          ? `
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Nome</th>
                              <th>Tipo</th>
                              <th>Descrição</th>
                              <th>Obrigatório</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${info.params
                              .map((param) => {
                                const [name, type, ...descParts] = param.split(" ");
                                const description = descParts.join(" ");
                                const isRequired = !param.includes("[") && !param.includes("opcional");
                                return `<tr>
                                  <td>${name}</td>
                                  <td>${type}</td>
                                  <td>${description}</td>
                                  <td class="${isRequired ? "param-required" : "param-optional"}">${isRequired ? "Sim" : "Não"}</td>
                                </tr>`;
                              })
                              .join("")}
                          </tbody>
                        </table>
                      `
                          : "<p>Este endpoint não possui parâmetros.</p>"
                      }
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingSuccess">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSuccess" aria-expanded="false" aria-controls="collapseSuccess">
                      Resposta de Sucesso
                    </button>
                  </h2>
                  <div id="collapseSuccess" class="accordion-collapse collapse" aria-labelledby="headingSuccess" data-bs-parent="#apiAccordion">
                    <div class="accordion-body">
                      <h4>Código de Status: ${info.successStatus || "200 OK"}</h4>
                      ${
                        info.success.length > 0
                          ? `
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Campo</th>
                              <th>Tipo</th>
                              <th>Descrição</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${info.success
                              .map((success) => {
                                const [field, type, ...descParts] = success.split(" ");
                                const description = descParts.join(" ");
                                return `<tr>
                                  <td>${field}</td>
                                  <td>${type}</td>
                                  <td>${description}</td>
                                </tr>`;
                              })
                              .join("")}
                          </tbody>
                        </table>
                      `
                          : "<p>Não há informações detalhadas sobre a resposta de sucesso.</p>"
                      }
                      ${
                        info.successExample
                          ? `
                        <div class="response-container">
                          <div class="response-header">Exemplo de Resposta:</div>
                          <div class="response-body">
                            <pre><code class="language-json">${formatJson(info.successExample)}</code></pre>
                          </div>
                        </div>
                      `
                          : ""
                      }
                      ${
                        info.responseSchema
                          ? `
                        <div class="schema">
                          <strong>Schema da Resposta:</strong>
                          <pre><code class="language-json">${formatJson(info.responseSchema)}</code></pre>
                        </div>
                      `
                          : ""
                      }
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingError">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseError" aria-expanded="false" aria-controls="collapseError">
                      Respostas de Erro
                    </button>
                  </h2>
                  <div id="collapseError" class="accordion-collapse collapse" aria-labelledby="headingError" data-bs-parent="#apiAccordion">
                    <div class="accordion-body">
                      ${
                        info.error.length > 0
                          ? `
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Código</th>
                              <th>Descrição</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${info.error
                              .map((error) => {
                                const [code, ...descParts] = error.split(" ");
                                const description = descParts.join(" ");
                                return `<tr>
                                  <td>${code}</td>
                                  <td>${description}</td>
                                </tr>`;
                              })
                              .join("")}
                          </tbody>
                        </table>
                      `
                          : "<p>Não há informações detalhadas sobre respostas de erro.</p>"
                      }
                      ${
                        info.errorExample
                          ? `
                        <div class="response-container">
                          <div class="response-header">Exemplo de Erro:</div>
                          <div class="response-body">
                            <pre><code class="language-json">${formatJson(info.errorExample)}</code></pre>
                          </div>
                        </div>
                      `
                          : ""
                      }
                    </div>
                  </div>
                </div>

                ${
                  info.notes
                    ? `
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingNotes">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNotes" aria-expanded="false" aria-controls="collapseNotes">
                        Notas Adicionais
                      </button>
                    </h2>
                    <div id="collapseNotes" class="accordion-collapse collapse" aria-labelledby="headingNotes" data-bs-parent="#apiAccordion">
                      <div class="accordion-body">
                        <p>${info.notes}</p>
                      </div>
                    </div>
                  </div>
                `
                    : ""
                }

                <div class="accordion-item try-it-out-accordion">
                  <h2 class="accordion-header" id="headingTryItOut">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTryItOut" aria-expanded="false" aria-controls="collapseTryItOut">
                      Try it out
                    </button>
                  </h2>
                  <div id="collapseTryItOut" class="accordion-collapse collapse" aria-labelledby="headingTryItOut" data-bs-parent="#apiAccordion">
                    <div class="accordion-body">
                      <h3>Testar Endpoint</h3>
                      ${pathParams
                        .map((param) => {
                          const paramName = param.slice(1);
                          return `
                        <div class="mb-3">
                          <label for="${paramName}" class="form-label">${paramName}</label>
                          <input type="text" class="form-control" id="${paramName}" placeholder="Digite o ${paramName}">
                        </div>`;
                        })
                        .join("")}
                      ${queryParams
                        .map((param) => {
                          const [name, type] = param.split(" ");
                          return `
                        <div class="mb-3">
                          <label for="${name}" class="form-label">${name}</label>
                          <input type="text" class="form-control" id="${name}" placeholder="${type}">
                        </div>`;
                        })
                        .join("")}
                      <button class="btn btn-success" onclick="testEndpoint('${info.method}', '${info.path}')">Execute</button>
                      <button class="btn btn-secondary" onclick="clearInputs(this)">Limpar</button>
                      <div id="testOutput" class="response-container mt-3" style="display: none;">
                        <div class="response-header">Resposta:</div>
                        <div class="response-body position-relative">
                          <button class="copy-button" onclick="copyResponse(this)">Copiar</button>
                          <pre><code class="language-json"></code></pre>
                        </div>
                        <div class="format-selector">
                          <label for="formatSelect" class="form-label">Formato de saída:</label>
                          <select id="formatSelect" class="form-select" onchange="changeOutputFormat(this)">
                            <option value="json" selected>JSON</option>
                            <option value="xml">XML</option>
                            <option value="yaml">YAML</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function formatJson(jsonString) {
        try {
          const obj = JSON.parse(jsonString);
          return JSON.stringify(obj, null, 2);
        } catch (e) {
          return jsonString;
        }
      }

      function clearInputs(button) {
        const accordionBody = button.closest(".accordion-body");
        const inputs = accordionBody.querySelectorAll("input");
        inputs.forEach((input) => (input.value = ""));

        // Limpar o resultado da consulta
        const testOutput = accordionBody.querySelector("#testOutput");
        testOutput.style.display = "none";
        const outputElement = testOutput.querySelector("pre code");
        outputElement.textContent = "";
      }

      function copyResponse(button) {
        const responseBody = button.closest(".response-body");
        const codeElement = responseBody.querySelector("code");
        const textToCopy = codeElement.textContent;

        navigator.clipboard
          .writeText(textToCopy)
          .then(() => {
            const originalText = button.textContent;
            button.textContent = "Copiado!";
            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);
          })
          .catch((err) => {
            console.error("Erro ao copiar texto: ", err);
          });
      }

      async function testEndpoint(method, path) {
        console.log(`Testando endpoint: ${method} ${path}`);

        method = method.toUpperCase();

        const accordionBody = event.target.closest(".accordion-body");
        const inputs = accordionBody.querySelectorAll("input");
        const params = {};
        inputs.forEach((input) => {
          if (input.value) {
            params[input.id] = input.id === "id" ? parseInt(input.value, 10) : input.value;
          }
        });

        console.log("Parâmetros enviados pelo usuário:", params);

        const outputElement = accordionBody.querySelector("#testOutput pre code");
        const responseContainer = accordionBody.querySelector("#testOutput");
        responseContainer.style.display = "block";

        try {
          const baseUrl = "http://localhost:3000"; // Ajuste esta URL conforme necessário
          let url = new URL(path, baseUrl);

          // Substituir parâmetros de rota
          Object.keys(params).forEach((key) => {
            const placeholder = `:${key}`;
            if (path.includes(placeholder)) {
              url = new URL(path.replace(placeholder, encodeURIComponent(params[key])), baseUrl);
              console.log(`Substituído ${placeholder} por ${params[key]} na URL`);
              delete params[key];
            }
          });

          // Adicionar parâmetros de query
          Object.keys(params).forEach((key) => {
            url.searchParams.append(key, params[key]);
            console.log(`Adicionado ${key}=${params[key]} à query string`);
          });

          console.log(`URL final: ${url.toString()}`);

          const options = {
            method: method,
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
          };

          if (method !== "GET" && Object.keys(params).length > 0) {
            options.body = JSON.stringify(params);
            console.log("Body da requisição:", options.body);
          }

          outputElement.textContent = "Carregando...";

          console.log(`Fazendo requisição: ${method} ${url}`);
          const response = await fetch(url, options);

          console.log("Status da resposta:", response.status);
          console.log("Headers da resposta:", Object.fromEntries(response.headers.entries()));

          let responseData;
          const contentType = response.headers.get("content-type");
          if (contentType && contentType.includes("application/json")) {
            responseData = await response.json();
          } else {
            responseData = await response.text();
          }

          console.log("Dados da resposta:", responseData);

          let formattedResponse = `Status: ${response.status} ${response.statusText}\n\n`;
          if (typeof responseData === "object") {
            formattedResponse += JSON.stringify(responseData, null, 2);
          } else {
            formattedResponse += responseData;
          }
          outputElement.textContent = formattedResponse;

          // Aplicar highlight.js
          outputElement.className = "language-json";
          hljs.highlightElement(outputElement);
        } catch (error) {
          console.error("Erro na requisição:", error);
          outputElement.textContent = `Erro: ${error.message}`;
          outputElement.className = "language-plaintext";
          hljs.highlightElement(outputElement);
        }
      }

      function changeOutputFormat(select) {
        const format = select.value;
        const outputElement = select.closest(".response-container").querySelector("pre code");
        const currentContent = outputElement.textContent;

        let formattedContent;
        switch (format) {
          case "xml":
            formattedContent = jsonToXml(JSON.parse(currentContent));
            break;
          case "yaml":
            formattedContent = jsonToYaml(JSON.parse(currentContent));
            break;
          default:
            formattedContent = currentContent;
        }

        outputElement.textContent = formattedContent;
        hljs.highlightElement(outputElement);
      }

      function jsonToXml(obj) {
        let xml = "";
        for (let prop in obj) {
          xml += obj[prop] instanceof Array ? "" : "<" + prop + ">";
          if (obj[prop] instanceof Array) {
            for (let array in obj[prop]) {
              xml += "<" + prop + ">";
              xml += jsonToXml(new Object(obj[prop][array]));
              xml += "</" + prop + ">";
            }
          } else if (typeof obj[prop] == "object") {
            xml += jsonToXml(new Object(obj[prop]));
          } else {
            xml += obj[prop];
          }
          xml += obj[prop] instanceof Array ? "" : "</" + prop + ">";
        }
        return xml.replace(/<\/?[0-9]{1,}>/g, "");
      }

      function jsonToYaml(obj, indent = "") {
        let yaml = "";
        for (let key in obj) {
          if (obj.hasOwnProperty(key)) {
            if (Array.isArray(obj[key])) {
              yaml += `${indent}${key}:\n`;
              obj[key].forEach((item) => {
                yaml += `${indent}- ${jsonToYaml(item, indent + "  ")}`;
              });
            } else if (typeof obj[key] === "object") {
              yaml += `${indent}${key}:\n${jsonToYaml(obj[key], indent + "  ")}`;
            } else {
              yaml += `${indent}${key}: ${obj[key]}\n`;
            }
          }
        }
        return yaml;
      }

      function initAccordions() {
        // Bootstrap 5 handles accordions automatically
      }

      function toggleContent() {
        const userTab = document.getElementById("users-tab");
        const devTab = document.getElementById("developers-tab");
        const userContent = document.getElementById("user-content");
        const devContent = document.getElementById("developer-content");
        const apiContent = document.getElementById("api-content");

        userTab.addEventListener("click", () => {
          userContent.style.display = "block";
          devContent.style.display = "none";
          apiContent.style.display = "none";
        });

        devTab.addEventListener("click", () => {
          userContent.style.display = "none";
          devContent.style.display = "block";
          apiContent.style.display = "none";
        });
      }

      renderSidebar();
      if (apiDocs.length > 0) {
        showApiItem(0);
      }
      hljs.highlightAll();
    </script>
  </body>
</html>
